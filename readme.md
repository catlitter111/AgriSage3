# ç“¶å­æ£€æµ‹ä¸è‡ªåŠ¨é‡‡æ‘˜æœºå™¨äººç³»ç»Ÿ

## é¡¹ç›®æ¦‚è¿°

è¿™æ˜¯ä¸€ä¸ªåŸºäºROS2çš„æ™ºèƒ½å†œä¸šæœºå™¨äººç³»ç»Ÿï¼Œä¸“é—¨ç”¨äºç“¶å­æ£€æµ‹å’Œè‡ªåŠ¨é‡‡æ‘˜ä»»åŠ¡ã€‚ç³»ç»Ÿé›†æˆäº†è®¡ç®—æœºè§†è§‰ã€æ·±åº¦æ„ŸçŸ¥ã€æœºå™¨äººæ§åˆ¶å’Œè¿œç¨‹é€šä¿¡ç­‰å¤šé¡¹æŠ€æœ¯ï¼Œèƒ½å¤Ÿè‡ªä¸»è¯†åˆ«å¹¶é‡‡æ‘˜ç›®æ ‡ç‰©ä½“ã€‚

### ä¸»è¦ç‰¹æ€§

- ğŸ¯ **é«˜ç²¾åº¦ç›®æ ‡æ£€æµ‹**ï¼šä½¿ç”¨YOLO11næ·±åº¦å­¦ä¹ æ¨¡å‹è¿›è¡Œç“¶å­æ£€æµ‹
- ğŸ‘ï¸ **3Dæ·±åº¦æ„ŸçŸ¥**ï¼šåŒç›®ç›¸æœºå®æ—¶è®¡ç®—ç›®æ ‡è·ç¦»ï¼ˆ0.2-5ç±³èŒƒå›´ï¼‰
- ğŸ¤– **æ™ºèƒ½é‡‡æ‘˜**ï¼š6è‡ªç”±åº¦æœºæ¢°è‡‚ç²¾å‡†æŠ“å–
- ğŸ“¡ **è¿œç¨‹æ§åˆ¶**ï¼šWebSocketå®æ—¶é€šä¿¡ï¼Œæ”¯æŒè¿œç¨‹ç›‘æ§å’Œæ§åˆ¶
- ğŸš€ **é«˜æ€§èƒ½å¤„ç†**ï¼šå¤šçº¿ç¨‹å¼‚æ­¥æ¶æ„ï¼Œ30+ FPSå®æ—¶æ£€æµ‹
- ğŸ”„ **åŒæ¨¡å¼æ“ä½œ**ï¼šæ”¯æŒæ‰‹åŠ¨é¥æ§å’Œè‡ªåŠ¨å·¡èˆªé‡‡æ‘˜

## ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     è¿œç¨‹æ§åˆ¶ä¸­å¿ƒ                          â”‚
â”‚                  (WebSocket Server)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ WebSocket
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  ROS2 ç³»ç»Ÿæ¶æ„                          â”‚
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ç“¶å­æ£€æµ‹èŠ‚ç‚¹  â”‚  â”‚ æœºå™¨äººæ§åˆ¶   â”‚  â”‚  èˆµæœºæ§åˆ¶     â”‚ â”‚
â”‚  â”‚(åŒç›®è§†è§‰)   â”‚  â”‚ (åº•ç›˜ç§»åŠ¨)   â”‚  â”‚ (æœºæ¢°è‡‚)     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚         â”‚                â”‚                   â”‚         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚              è‡ªåŠ¨é‡‡æ‘˜æ§åˆ¶å™¨                        â”‚ â”‚
â”‚  â”‚          (çŠ¶æ€æœº & å†³ç­–é€»è¾‘)                      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## åŠŸèƒ½æ¨¡å—è¯¦è§£

### 1. ç“¶å­æ£€æµ‹æ¨¡å— (`integrated_bottle_detection_node`)

- **åŒç›®ç›¸æœºé‡‡é›†**ï¼š1280x480åˆ†è¾¨ç‡ï¼Œå·¦å³ç›¸æœºåŒæ­¥é‡‡é›†
- **YOLOæ£€æµ‹**ï¼šåŸºäºRKNNä¼˜åŒ–çš„YOLO11næ¨¡å‹ï¼Œä¸“é—¨é’ˆå¯¹ç“¶å­æ£€æµ‹ä¼˜åŒ–
- **æ·±åº¦è®¡ç®—**ï¼šç«‹ä½“åŒ¹é…ç®—æ³•è®¡ç®—3Dç‚¹äº‘ï¼Œç²¾ç¡®æµ‹é‡ç›®æ ‡è·ç¦»
- **å¤šçº¿ç¨‹å¤„ç†**ï¼š3ä¸ªNPUæ ¸å¿ƒå¹¶è¡Œå¤„ç†ï¼Œå¤§å¹…æå‡æ£€æµ‹é€Ÿåº¦

### 2. æœºå™¨äººæ§åˆ¶æ¨¡å— (`robot_control_node`)

- **ä¸²å£é€šä¿¡**ï¼šé€šè¿‡ä¸²å£ä¸åº•å±‚ç”µæœºæ§åˆ¶å™¨é€šä¿¡
- **è¿åŠ¨æ§åˆ¶**ï¼šæ”¯æŒå‰è¿›ã€åé€€ã€å·¦è½¬ã€å³è½¬ç­‰åŸºæœ¬åŠ¨ä½œ
- **é€Ÿåº¦è°ƒèŠ‚**ï¼šçº¿é€Ÿåº¦æœ€å¤§0.5m/sï¼Œè§’é€Ÿåº¦æœ€å¤§1.0rad/s
- **çŠ¶æ€åé¦ˆ**ï¼šå®æ—¶ä¸ŠæŠ¥ä½ç½®ã€ç”µé‡ã€CPUä½¿ç”¨ç‡ç­‰ä¿¡æ¯

### 3. èˆµæœºæ§åˆ¶æ¨¡å— (`servo_control_node`)

- **6è½´æœºæ¢°è‡‚**ï¼šç²¾ç¡®æ§åˆ¶6ä¸ªèˆµæœºå®ç°å¤æ‚é‡‡æ‘˜åŠ¨ä½œ
- **è§†è§‰è·Ÿè¸ª**ï¼šæ ¹æ®æ£€æµ‹ç»“æœè‡ªåŠ¨è°ƒæ•´èˆµæœºè§’åº¦å¯¹å‡†ç›®æ ‡
- **é‡‡æ‘˜åºåˆ—**ï¼šé¢„å®šä¹‰5æ­¥é‡‡æ‘˜åŠ¨ä½œåºåˆ—ï¼Œç¡®ä¿ç¨³å®šæŠ“å–
- **ä½ç½®åé¦ˆ**ï¼šå®æ—¶è¯»å–èˆµæœºä½ç½®ï¼Œé—­ç¯æ§åˆ¶

### 4. WebSocketé€šä¿¡æ¨¡å— (`websocket_bridge_node`)

- **å®æ—¶è§†é¢‘æµ**ï¼šJPEGå‹ç¼©ä¼ è¾“ï¼Œæ”¯æŒåŠ¨æ€è´¨é‡è°ƒæ•´
- **åŒå‘æ§åˆ¶**ï¼šæ¥æ”¶è¿œç¨‹æ§åˆ¶å‘½ä»¤ï¼Œä¸ŠæŠ¥æœºå™¨äººçŠ¶æ€
- **è‡ªåŠ¨é‡è¿**ï¼šç½‘ç»œæ–­å¼€åè‡ªåŠ¨å°è¯•é‡è¿
- **æ•°æ®å‹ç¼©**ï¼šé«˜æ•ˆçš„æ•°æ®ç¼–ç ï¼Œé™ä½å¸¦å®½å ç”¨

### 5. è‡ªåŠ¨é‡‡æ‘˜æ§åˆ¶å™¨ (`auto_harvest_controller`)

- **ç›®æ ‡æœç´¢**ï¼šè‡ªåŠ¨æ—‹è½¬æœç´¢è§†é‡å†…çš„ç“¶å­
- **æ™ºèƒ½æ¥è¿‘**ï¼šæ ¹æ®è·ç¦»è‡ªåŠ¨è°ƒæ•´æ¥è¿‘ç­–ç•¥
  - è¿œè·ç¦»(>1.2m)ï¼šå¿«é€Ÿæ¥è¿‘
  - ä¸­è·ç¦»(0.8-1.2m)ï¼šç²¾ç»†è°ƒæ•´
  - è¿‘è·ç¦»(0.5-0.8m)ï¼šèˆµæœºè·Ÿè¸ª
  - é‡‡æ‘˜è·ç¦»(0.3-0.5m)ï¼šæ‰§è¡ŒæŠ“å–
- **é¿éšœä¿æŠ¤**ï¼šè·ç¦»è¿‡è¿‘è‡ªåŠ¨åé€€

## å®‰è£…ä¸é…ç½®

### ç³»ç»Ÿè¦æ±‚

- **æ“ä½œç³»ç»Ÿ**ï¼šUbuntu 20.04/22.04
- **ROSç‰ˆæœ¬**ï¼šROS2 Foxy/Humble
- **ç¡¬ä»¶è¦æ±‚**ï¼š
  - RK3588æˆ–ç±»ä¼¼çš„NPUæ”¯æŒ
  - USBåŒç›®ç›¸æœº
  - ä¸²å£è®¾å¤‡ï¼ˆæœºå™¨äººåº•ç›˜ã€èˆµæœºæ§åˆ¶å™¨ï¼‰

### ä¾èµ–å®‰è£…

```bash
# å®‰è£…ROS2ä¾èµ–
sudo apt update
sudo apt install ros-$ROS_DISTRO-cv-bridge ros-$ROS_DISTRO-image-transport

# å®‰è£…Pythonä¾èµ–
pip3 install opencv-python numpy pandas websocket-client pyserial

# å®‰è£…RKNNè¿è¡Œæ—¶ï¼ˆæ ¹æ®å…·ä½“ç¡¬ä»¶å¹³å°ï¼‰
# å‚è€ƒ: https://github.com/rockchip-linux/rknn-toolkit2
```

### ç¼–è¯‘å®‰è£…

```bash
# åˆ›å»ºå·¥ä½œç©ºé—´
mkdir -p ~/bottle_ws/src
cd ~/bottle_ws/src

# å…‹éš†ä»£ç 
git clone <repository_url> bottle_detection_ros2

# ç¼–è¯‘
cd ~/bottle_ws
colcon build --packages-select bottle_detection_ros2

# è®¾ç½®ç¯å¢ƒ
source install/setup.bash
```

### é…ç½®æ–‡ä»¶

1. **ç›¸æœºæ ‡å®šæ–‡ä»¶**ï¼šå°†ç›¸æœºæ ‡å®šå‚æ•°ä¿å­˜åˆ° `data/out.xls`
2. **YOLOæ¨¡å‹**ï¼šå°†è®­ç»ƒå¥½çš„RKNNæ¨¡å‹æ”¾åˆ° `data/yolo11n.rknn`

## ä½¿ç”¨æ–¹æ³•

### 1. å¯åŠ¨å®Œæ•´ç³»ç»Ÿ

```bash
ros2 launch bottle_detection_ros2 integrated_system.launch.py
```

### 2. å•ç‹¬å¯åŠ¨ç“¶å­æ£€æµ‹

```bash
ros2 launch bottle_detection_ros2 bottle_detection.launch.py show_display:=true
```

### 3. å¯åŠ¨å‚æ•°è¯´æ˜

```bash
# è‡ªå®šä¹‰å‚æ•°å¯åŠ¨
ros2 launch bottle_detection_ros2 integrated_system.launch.py \
  camera_id:=1 \
  robot_id:=robot_001 \
  ws_server_url:=ws://your-server:1234/ws/robot/robot_001 \
  show_display:=false
```

### ä¸»è¦å¯åŠ¨å‚æ•°

| å‚æ•°å | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|--------|------|
| camera_id | 1 | ç›¸æœºè®¾å¤‡ID |
| model_path | yolo11n.rknn | RKNNæ¨¡å‹è·¯å¾„ |
| ws_server_url | ws://101.201.150.96:1234/ws/robot/robot_123 | WebSocketæœåŠ¡å™¨åœ°å€ |
| robot_id | robot_123 | æœºå™¨äººå”¯ä¸€æ ‡è¯† |
| show_display | true | æ˜¯å¦æ˜¾ç¤ºå›¾åƒçª—å£ |
| min_distance | 0.2 | æœ€å°æ£€æµ‹è·ç¦»(ç±³) |
| max_distance | 5.0 | æœ€å¤§æ£€æµ‹è·ç¦»(ç±³) |

## ROS2è¯é¢˜æ¥å£

### å‘å¸ƒè¯é¢˜

| è¯é¢˜åç§° | æ¶ˆæ¯ç±»å‹ | æè¿° |
|---------|---------|------|
| /camera/left/image_raw | sensor_msgs/Image | å·¦ç›¸æœºåŸå§‹å›¾åƒ |
| /camera/right/image_raw | sensor_msgs/Image | å³ç›¸æœºåŸå§‹å›¾åƒ |
| /bottle_detection/annotated_image | sensor_msgs/Image | æ ‡æ³¨åçš„æ£€æµ‹å›¾åƒ |
| /bottle_detection/compressed_image | sensor_msgs/CompressedImage | å‹ç¼©çš„æ£€æµ‹å›¾åƒ |
| /bottle_detection/nearest_position | geometry_msgs/PointStamped | æœ€è¿‘ç“¶å­çš„3Dä½ç½® |
| /bottle_detection/nearest_distance | std_msgs/Float32 | æœ€è¿‘ç“¶å­çš„è·ç¦» |
| /bottle_detection/count | std_msgs/Int32 | æ£€æµ‹åˆ°çš„ç“¶å­æ•°é‡ |
| /bottle_detection/info | std_msgs/String | è¯¦ç»†æ£€æµ‹ä¿¡æ¯(JSON) |
| /robot/status | bottle_detection_msgs/RobotStatus | æœºå™¨äººçŠ¶æ€ |
| /servo/status | bottle_detection_msgs/ServoStatus | èˆµæœºçŠ¶æ€ |

### è®¢é˜…è¯é¢˜

| è¯é¢˜åç§° | æ¶ˆæ¯ç±»å‹ | æè¿° |
|---------|---------|------|
| /cmd_vel | geometry_msgs/Twist | é€Ÿåº¦æ§åˆ¶å‘½ä»¤ |
| /robot/mode | std_msgs/String | å·¥ä½œæ¨¡å¼åˆ‡æ¢ |
| /robot/harvest_command | bottle_detection_msgs/HarvestCommand | é‡‡æ‘˜æ§åˆ¶å‘½ä»¤ |
| /servo/command | bottle_detection_msgs/ServoCommand | èˆµæœºæ§åˆ¶å‘½ä»¤ |
| /video/quality_preset | std_msgs/String | è§†é¢‘è´¨é‡è®¾ç½® |

## å·¥ä½œæ¨¡å¼

### æ‰‹åŠ¨æ¨¡å¼
- é€šè¿‡WebSocketæ¥æ”¶è¿œç¨‹æ§åˆ¶å‘½ä»¤
- å®æ—¶è§†é¢‘ä¼ è¾“ï¼Œæ“ä½œå‘˜è¿œç¨‹è§‚å¯Ÿ
- æ‰‹åŠ¨æ§åˆ¶æœºå™¨äººç§»åŠ¨å’Œé‡‡æ‘˜

### è‡ªåŠ¨æ¨¡å¼
- è‡ªä¸»æœç´¢ç›®æ ‡
- è‡ªåŠ¨æ¥è¿‘å¹¶å¯¹å‡†
- è‡ªåŠ¨æ‰§è¡Œé‡‡æ‘˜åºåˆ—
- å®Œæˆåç»§ç»­æœç´¢ä¸‹ä¸€ä¸ªç›®æ ‡

## æ•…éšœæ’é™¤

### ç›¸æœºæ— æ³•æ‰“å¼€
```bash
# æ£€æŸ¥ç›¸æœºè®¾å¤‡
v4l2-ctl --list-devices

# æµ‹è¯•ç›¸æœº
v4l2-ctl --device=/dev/video1 --stream-mmap --stream-to=test.raw --stream-count=1
```

### ä¸²å£æƒé™é—®é¢˜
```bash
# æ·»åŠ ç”¨æˆ·åˆ°dialoutç»„
sudo usermod -a -G dialout $USER

# ä¸´æ—¶æˆæƒ
sudo chmod 666 /dev/ttyS3 /dev/ttyS9
```

### RKNNæ¨¡å‹åŠ è½½å¤±è´¥
- ç¡®è®¤æ¨¡å‹æ–‡ä»¶è·¯å¾„æ­£ç¡®
- æ£€æŸ¥RKNNè¿è¡Œæ—¶ç‰ˆæœ¬å…¼å®¹æ€§
- éªŒè¯NPUé©±åŠ¨æ­£å¸¸å·¥ä½œ

## æ€§èƒ½ä¼˜åŒ–

### æ£€æµ‹æ€§èƒ½
- **å•çº¿ç¨‹**ï¼šçº¦10-15 FPS
- **3çº¿ç¨‹**ï¼šçº¦25-30 FPS
- **6çº¿ç¨‹**ï¼šçº¦35-40 FPSï¼ˆç¡¬ä»¶é™åˆ¶ï¼‰

### ä¼˜åŒ–å»ºè®®
1. è°ƒæ•´`thread_num`å‚æ•°åŒ¹é…ç¡¬ä»¶èƒ½åŠ›
2. é™ä½`publish_rate`å‡å°‘CPUå ç”¨
3. ä½¿ç”¨`low`æˆ–`very_low`è§†é¢‘è´¨é‡é™ä½å¸¦å®½
4. å…³é—­`show_display`æå‡æ€§èƒ½

## å¼€å‘æŒ‡å—

### æ·»åŠ æ–°çš„æ£€æµ‹ç›®æ ‡
1. ä¿®æ”¹`CLASSES`åˆ—è¡¨æ·»åŠ æ–°ç±»åˆ«
2. é‡æ–°è®­ç»ƒYOLOæ¨¡å‹åŒ…å«æ–°ç›®æ ‡
3. æ›´æ–°æ£€æµ‹è¿‡æ»¤é€»è¾‘

### è‡ªå®šä¹‰é‡‡æ‘˜åŠ¨ä½œ
1. ä¿®æ”¹`ARM_COMMANDS`å®šä¹‰æ–°çš„åŠ¨ä½œåºåˆ—
2. è°ƒæ•´`harvest_state_machine`çŠ¶æ€è½¬æ¢
3. æµ‹è¯•æ–°åŠ¨ä½œçš„ç¨³å®šæ€§å’ŒæˆåŠŸç‡

### æ‰©å±•é€šä¿¡åè®®
1. åœ¨`websocket_bridge_node`æ·»åŠ æ–°æ¶ˆæ¯ç±»å‹
2. å®ç°å¯¹åº”çš„å¤„ç†å‡½æ•°
3. æ›´æ–°æœåŠ¡å™¨ç«¯åè®®

## è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ MIT è®¸å¯è¯ã€‚è¯¦è§ [LICENSE](LICENSE) æ–‡ä»¶ã€‚

## è´¡çŒ®æŒ‡å—

æ¬¢è¿æäº¤Issueå’ŒPull Requestã€‚æäº¤ä»£ç å‰è¯·ç¡®ä¿ï¼š
- ä»£ç ç¬¦åˆROS2ç¼–ç è§„èŒƒ
- æ·»åŠ å¿…è¦çš„æ³¨é‡Šå’Œæ–‡æ¡£
- é€šè¿‡æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹

## è”ç³»æ–¹å¼

- é¡¹ç›®ç»´æŠ¤è€…ï¼š[ç»´æŠ¤è€…åç§°]
- é‚®ç®±ï¼š[email]
- é¡¹ç›®ä¸»é¡µï¼š[project-url]